#!/bin/bash

shopt -s nullglob

echo_game_item () {
  echo "  <item label=\"$1\"><action name=\"Execute\">\
<execute>steam steam://run/$2</execute></action></item>"
}

cat <<-EOF
<openbox_pipe_menu>
  <item label="steam client">
    <action name="Execute">
      <command>steam</command>
      <startupnotify>
        <enabled>yes</enabled>
      </startupnotify>
    </action>
  </item>
  <separator />
EOF
for file in ~/.steam/steam/steamapps/*.acf; do
  ID=$(grep -w -m 1 '"appid"' "$file" \
       | sed -r 's/[^"]*"appid"[^"]*"([^"]*)"/\1/')
  NAME=$(grep -w -m 1 '"name"' "$file" \
         | sed -r -e 's/[^"]*"name"[^"]*"([^"]*)"/\1/' -e 's/&/&amp;/')
  if ! [[ "$NAME" =~ Proton* ]] && ! [[ "$NAME" =~ Steamworks* ]]; then
    echo_game_item "$NAME" $ID
  fi
done | sort
echo '</openbox_pipe_menu>'
